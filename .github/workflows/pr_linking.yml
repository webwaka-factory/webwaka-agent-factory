name: Pull Request Linking

on:
  pull_request:
    types: [opened, synchronize]
  workflow_run:
    workflows: ["CI"]
    types: [completed]

jobs:
  link_pr_to_issue:
    name: Link PR to Issue
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    
    steps:
      - name: Extract Issue Number
        id: extract
        uses: actions/github-script@v7
        with:
          script: |
            const prBody = context.payload.pull_request.body || '';
            const prTitle = context.payload.pull_request.title || '';
            
            // Look for issue references in PR body and title
            const patterns = [
              /(?:close[sd]?|fix(?:e[sd])?|resolve[sd]?)\s+#(\d+)/gi,
              /#(\d+)/g
            ];
            
            let issueNumber = null;
            
            for (const pattern of patterns) {
              const matches = [...prBody.matchAll(pattern)];
              if (matches.length > 0) {
                issueNumber = matches[0][1];
                break;
              }
            }
            
            if (!issueNumber) {
              const matches = [...prTitle.matchAll(patterns[1])];
              if (matches.length > 0) {
                issueNumber = matches[0][1];
              }
            }
            
            if (!issueNumber) {
              core.setFailed('No issue reference found in PR. Please include "Resolves #123" in the PR body.');
              return;
            }
            
            core.setOutput('issue_number', issueNumber);
            console.log(`Found issue reference: #${issueNumber}`);
            return issueNumber;

      - name: Transition Issue to Implemented
        if: steps.extract.outputs.issue_number
        uses: actions/github-script@v7
        with:
          script: |
            const issueNumber = parseInt('${{ steps.extract.outputs.issue_number }}');
            
            // Get current issue state
            const issue = await github.rest.issues.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber
            });
            
            const stateLabel = issue.data.labels.find(l => l.name.startsWith('state:'));
            const currentState = stateLabel ? stateLabel.name : 'none';
            
            // Only transition if currently in 'implementing' state
            if (currentState === 'state: implementing') {
              // Remove old state
              await github.rest.issues.removeLabel({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issueNumber,
                name: currentState
              });
              
              // Add new state
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issueNumber,
                labels: ['state: implemented']
              });
              
              // Post comment
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issueNumber,
                body: `✅ **Pull Request Opened**\n\n**PR:** #${context.payload.pull_request.number}\n**Author:** @${context.payload.pull_request.user.login}\n**State:** \`${currentState}\` → \`state: implemented\`\n\nCI tests will run automatically. The issue will transition to \`state: testing\` once tests complete.`
              });
              
              console.log(`Transitioned issue #${issueNumber} to 'state: implemented'`);
            } else {
              console.log(`Issue #${issueNumber} is in state '${currentState}', not transitioning.`);
            }

  handle_test_results:
    name: Handle CI Test Results
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_run' && github.event.workflow_run.conclusion != 'cancelled'
    
    steps:
      - name: Get PR Number
        id: pr
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = context.payload.workflow_run.pull_requests[0]?.number;
            if (!prNumber) {
              console.log('No PR associated with this workflow run');
              return null;
            }
            core.setOutput('pr_number', prNumber);
            return prNumber;

      - name: Get Issue from PR
        if: steps.pr.outputs.pr_number
        id: issue
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = parseInt('${{ steps.pr.outputs.pr_number }}');
            
            const pr = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: prNumber
            });
            
            const prBody = pr.data.body || '';
            const pattern = /(?:close[sd]?|fix(?:e[sd])?|resolve[sd]?)\s+#(\d+)/gi;
            const matches = [...prBody.matchAll(pattern)];
            
            if (matches.length === 0) {
              console.log('No issue reference found in PR');
              return null;
            }
            
            const issueNumber = matches[0][1];
            core.setOutput('issue_number', issueNumber);
            return issueNumber;

      - name: Update Issue Based on Test Results
        if: steps.issue.outputs.issue_number
        uses: actions/github-script@v7
        with:
          script: |
            const issueNumber = parseInt('${{ steps.issue.outputs.issue_number }}');
            const conclusion = '${{ github.event.workflow_run.conclusion }}';
            
            // Get current issue state
            const issue = await github.rest.issues.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber
            });
            
            const stateLabel = issue.data.labels.find(l => l.name.startsWith('state:'));
            const currentState = stateLabel ? stateLabel.name : 'none';
            
            let newState = null;
            let message = '';
            
            if (conclusion === 'success' && currentState === 'state: implemented') {
              newState = 'state: testing';
              message = `✅ **CI Tests Passed**\n\nAll tests passed successfully. Issue transitioned to \`state: testing\`.\n\nNext step: Manual verification before closing.`;
            } else if (conclusion === 'failure' && (currentState === 'state: implemented' || currentState === 'state: testing')) {
              newState = 'state: failed-testing';
              message = `❌ **CI Tests Failed**\n\nTests failed. Issue transitioned to \`state: failed-testing\`.\n\nThe task is now available for another agent to claim and fix.\n\n**Workflow Run:** ${context.payload.workflow_run.html_url}`;
              
              // Unassign the issue
              const assignee = issue.data.assignee?.login;
              if (assignee) {
                await github.rest.issues.removeAssignees({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: issueNumber,
                  assignees: [assignee]
                });
              }
            }
            
            if (newState) {
              // Remove old state
              if (currentState !== 'none') {
                await github.rest.issues.removeLabel({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: issueNumber,
                  name: currentState
                });
              }
              
              // Add new state
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issueNumber,
                labels: [newState]
              });
              
              // Post comment
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issueNumber,
                body: message
              });
              
              console.log(`Updated issue #${issueNumber}: ${currentState} → ${newState}`);
            }
