name: Pull Request Linking
on:
  pull_request:
    types: [opened, synchronize]
  workflow_run:
    workflows: ["CI"]
    types: [completed]

permissions:
  issues: write
  pull-requests: read
  contents: read

jobs:
  link_pr_to_issue:
    name: Link PR to Issue
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'

    steps:
      - name: Extract Issue Number
        id: extract
        uses: actions/github-script@v7
        with:
          script: |
            const prBody = context.payload.pull_request.body || '';
            const prTitle = context.payload.pull_request.title || '';

            // Look for issue references in PR body and title
            const patterns = [
              /(?:close[sd]?|fix(?:e[sd])?|resolve[sd]?)\s+#(\d+)/gi,
              /#(\d+)/g
            ];

            let issueNumber = null;

            for (const pattern of patterns) {
              const matches = [...prBody.matchAll(pattern)];
              if (matches.length > 0) {
                issueNumber = matches[0][1];
                break;
              }
            }

            if (!issueNumber) {
              const matches = [...prTitle.matchAll(patterns[1])];
              if (matches.length > 0) {
                issueNumber = matches[0][1];
              }
            }

            if (!issueNumber) {
              core.setFailed('No issue reference found in PR. Please include "Resolves #123" in the PR body.');
              return;
            }

            core.setOutput('issue_number', issueNumber);
            console.log(`Found issue reference: #${issueNumber}`);
            return issueNumber;

      - name: Transition Issue to Implemented
        if: steps.extract.outputs.issue_number
        uses: actions/github-script@v7
        with:
          script: |
            const issueNumber = parseInt('${{ steps.extract.outputs.issue_number }}');

            // Get current issue state
            const issue = await github.rest.issues.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber
            });

            const stateLabel = issue.data.labels.find(l => l.name.startsWith('state:'));
            const currentState = stateLabel ? stateLabel.name : 'none';

            // Only transition if currently in 'implementing' state
            if (currentState === 'state: implementing') {
              // Remove old state
              await github.rest.issues.removeLabel({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issueNumber,
                name: currentState
              });

              // Add new state
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issueNumber,
                labels: ['state: implemented']
              });

              // Post comment - NO AUTO-ASSIGNMENT
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issueNumber,
                body: `✅ **Pull Request Opened**

**PR:** #${{ github.event.pull_request.number }}
**Author:** @${{ github.event.pull_request.user.login }}
**State:** \`${currentState}\` → \`state: implemented\`

CI tests will run automatically. The issue will transition to \`state: testing\` once tests complete.

**Note:** This issue remains unassigned. QA agents can claim it using \`/claim\` when ready to test.`
              });

              console.log(`Transitioned issue #${issueNumber} to 'state: implemented' (NO AUTO-ASSIGNMENT)`);
            } else {
              console.log(`Issue #${issueNumber} is in state '${currentState}', not transitioning.`);
            }
