name: State Machine Enforcement

on:
  issue_comment:
    types: [created, edited]
  issues:
    types: [labeled]

jobs:
  handle_slash_command:
    if: github.event_name == 'issue_comment'
    runs-on: ubuntu-latest
    permissions:
      issues: write
      contents: read
    steps:
      - name: Process Slash Commands
        uses: actions/github-script@v6
        with:
          script: |
            const issue = context.payload.issue;
            const comment = context.payload.comment;
            const actor = comment.user.login;

            // Extract command
            const commandMatch = comment.body.match(/^\/(\w+)(?:\s+(.*))?$/m);
            if (!commandMatch) return;

            const command = commandMatch[1];
            const args = commandMatch[2] || '';

            console.log(`Processing command: /${command}`);

            // Get current state
            const stateLabel = issue.labels.find(
              l => l.name.startsWith('state:')
            );
            const currentState = stateLabel
              ? stateLabel.name.replace('state: ', '')
              : 'unknown';

            // CLAIM COMMAND - Only command that assigns
            if (command === 'claim') {
              // Check if already assigned
              if (issue.assignees && issue.assignees.length > 0) {
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: issue.number,
                  body:
                    `‚ùå **Already Assigned**\n\n` +
                    `This task is already assigned to ` +
                    `@${issue.assignees[0].login}. ` +
                    `Please choose another task.`
                });
                return;
              }

              // Assign to the actor
              await github.rest.issues.addAssignees({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                assignees: [actor]
              });

              // Update state to implementing if ready-for-implementation
              if (currentState === 'ready-for-implementation') {
                await github.rest.issues.removeLabel({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: issue.number,
                  name: 'state: ready-for-implementation'
                });

                await github.rest.issues.addLabels({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: issue.number,
                  labels: ['state: implementing']
                });
              }

              const msg = `‚úÖ **Claimed by @${actor}**\n\nThis task is now assigned to you. Please follow the instructions and update status as you progress.\n\n**Next Steps:**\n- For Testing: Use \`/complete-testing\` when done\n- For Implementation: Use \`/complete-implementation\` when done\n- For Verification: Use \`/approve\` when done\n- If Tests Fail: Use \`/fail-testing <reason>\`\n\nTask will be **auto-unassigned** upon completion.\n\nNeed help? Type \`/help\``;

              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                body: msg
              });
              return;
            }

            // COMPLETE-TESTING COMMAND - Unassign and transition
            if (command === 'complete-testing') {
              if (currentState !== 'testing') {
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: issue.number,
                  body: `‚ùå **Wrong State**\n\nThis command only works in \`state: testing\`. Current state: \`${currentState}\``
                });
                return;
              }

              // Remove testing label
              await github.rest.issues.removeLabel({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                name: 'state: testing'
              });

              // Add verification label
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                labels: ['state: verification']
              });

              // UNASSIGN - Do NOT assign to anyone
              await github.rest.issues.removeAssignees({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                assignees: [actor]
              });

              const msg = `‚úÖ **Testing Completed by @${actor}**\n\nThis issue has been transitioned to verification phase.\n**Task has been unassigned** and is ready for next phase.\n\nThank you for thorough testing!`;

              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                body: msg
              });
              return;
            }

            // FAIL-TESTING COMMAND - Unassign and reopen
            if (command === 'fail-testing') {
              if (currentState !== 'testing') {
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: issue.number,
                  body: `‚ùå **Wrong State**\n\nThis command only works in \`state: testing\`. Current state: \`${currentState}\``
                });
                return;
              }

              // Remove testing label
              await github.rest.issues.removeLabel({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                name: 'state: testing'
              });

              // Add failed-testing label
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                labels: ['state: failed-testing']
              });

              // UNASSIGN - Do NOT assign to anyone
              await github.rest.issues.removeAssignees({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                assignees: [actor]
              });

              const msg = `‚ùå **Testing Failed by @${actor}**\n\nFailure Reason:\n${args || 'See comments above for details'}\n\nThis issue has been reopened for remediation.\n**Task has been unassigned** and is ready for another agent to fix.\n\nThank you for thorough testing!`;

              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                body: msg
              });
              return;
            }

            // COMPLETE-IMPLEMENTATION COMMAND - Unassign and transition
            if (command === 'complete-implementation') {
              if (currentState !== 'implementing') {
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: issue.number,
                  body: `‚ùå **Wrong State**\n\nThis command only works in \`state: implementing\`. Current state: \`${currentState}\``
                });
                return;
              }

              // Remove implementing label
              await github.rest.issues.removeLabel({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                name: 'state: implementing'
              });

              // Add testing label
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                labels: ['state: testing']
              });

              // UNASSIGN - Do NOT assign to anyone
              await github.rest.issues.removeAssignees({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                assignees: [actor]
              });

              const msg = `‚úÖ **Implementation Completed by @${actor}**\n\nThis issue has been transitioned to testing phase.\n**Task has been unassigned** and is ready for QA agents to claim.\n\nThank you for the implementation!`;

              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                body: msg
              });
              return;
            }

            // APPROVE COMMAND - Unassign and close
            if (command === 'approve') {
              if (currentState !== 'verification') {
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: issue.number,
                  body: `‚ùå **Wrong State**\n\nThis command only works in \`state: verification\`. Current state: \`${currentState}\``
                });
                return;
              }

              // Remove verification label
              await github.rest.issues.removeLabel({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                name: 'state: verification'
              });

              // Add closed label
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                labels: ['state: closed']
              });

              // UNASSIGN - Do NOT assign to anyone
              await github.rest.issues.removeAssignees({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                assignees: [actor]
              });

              // Close the issue
              await github.rest.issues.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                state: 'closed'
              });

              const msg = `‚úÖ **Approved by @${actor}**\n\nThis issue has been verified and approved. Status: \`state: closed\`\n\nThank you for completing this task!`;

              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                body: msg
              });
              return;
            }

            // HELP COMMAND
            if (command === 'help') {
              const helpMsg = `üìö **Available Commands**\n\n\`/claim\` - Claim this task\n\`/complete-implementation\` - Mark implementation complete\n\`/complete-testing\` - Mark testing complete\n\`/fail-testing <reason>\` - Report test failure\n\`/approve\` - Approve and close\n\`/help\` - Show this help\n\n**Common Mistakes:**\n‚ùå \`/state testing\` - NOT valid\n‚úÖ Use \`/complete-testing\` instead`;

              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                body: helpMsg
              });
              return;
            }

            // Unknown command
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issue.number,
              body: `‚ùå **Unknown Command: \`/${command}\`**\n\nType \`/help\` to see available commands.`
            });

  auto_reopen_failed_testing:
    if: ${{ contains(github.event.issue.labels.*.name, 'state:failed-testing') }}
    runs-on: ubuntu-latest
    permissions:
      issues: write
    steps:
      - name: Reopen Failed Testing Issues
        uses: actions/github-script@v6
        with:
          script: |
            const issue = context.payload.issue;

            // Remove failed-testing label
            await github.rest.issues.removeLabel({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issue.number,
              name: 'state: failed-testing'
            });

            // Add implementing label
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issue.number,
              labels: ['state: implementing', 'needs-claiming', 'reopened-from-failed-testing']
            });

            // ENSURE UNASSIGNED
            if (issue.assignees && issue.assignees.length > 0) {
              const assigneeNames = issue.assignees.map(a => a.login);
              await github.rest.issues.removeAssignees({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                assignees: assigneeNames
              });
            }

            const msg = `üîÑ **Reopened for Remediation**\n\nThis issue failed testing and has been reopened.\n\n**Status:** \`state: implementing\` (unassigned)\n**Label:** \`needs-claiming\` - Ready for agent to claim\n\nTo claim this task, comment: \`/claim\``;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issue.number,
              body: msg
            });
